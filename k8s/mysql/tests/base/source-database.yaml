# Source MySQL database for testing database branching
apiVersion: v1
kind: Pod
metadata:
  name: mysql-test
  labels:
    app: mysql-test
    test-component: source-db
spec:
  initContainers:
    - name: init-db-script
      image: mysql:8.0
      command:
        - sh
        - -c
        - |
          cat <<'EOF' > /docker-entrypoint-initdb.d/01-init-user-db.sql
          CREATE DATABASE IF NOT EXISTS user;
          USE user;
          CREATE TABLE IF NOT EXISTS users (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(50),
            email VARCHAR(100)
          );
          INSERT INTO users (name, email) VALUES
            ('Alice', 'alice@example.com'),
            ('Bob', 'bob@example.com');
          CREATE TABLE IF NOT EXISTS orders (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user VARCHAR(50),
            created_at TIMESTAMP
          );
          INSERT INTO orders (user, created_at) VALUES
            ('Alice', '2025-01-10 12:00:00'),
            ('Alice', '2025-02-15 09:30:00'),
            ('Bob',   '2025-03-22 17:45:00'),
            ('Bob',   '2025-04-05 08:20:00');
          EOF
      volumeMounts:
        - name: initdb
          mountPath: /docker-entrypoint-initdb.d
  containers:
    - name: mysql
      image: mysql:8.0
      env:
        - name: MYSQL_ROOT_PASSWORD
          value: examplepassword
      ports:
        - containerPort: 3306
      volumeMounts:
        - name: initdb
          mountPath: /docker-entrypoint-initdb.d
  volumes:
    - name: initdb
      emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: mysql-test
spec:
  selector:
    app: mysql-test
  ports:
    - name: mysql
      port: 3306
      targetPort: 3306
---
apiVersion: v1
kind: Secret
metadata:
  name: mysql-connection-secret
type: Opaque
stringData:
  url: mysql://root:examplepassword@mysql-test/user

