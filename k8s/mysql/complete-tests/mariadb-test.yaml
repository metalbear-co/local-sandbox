apiVersion: v1
kind: Pod
metadata:
  name: mariadb-test
  namespace: test-mirrord
  labels:
    app: mariadb-test
spec:
  initContainers:
    - name: init-db-script
      image: mariadb:10.11
      command:
        - sh
        - -c
        - |
          cat <<'EOF' > /docker-entrypoint-initdb.d/01-init-user-db.sql
          CREATE DATABASE IF NOT EXISTS user;
          USE user;
          CREATE TABLE IF NOT EXISTS users (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(50),
            email VARCHAR(100)
          );
          INSERT INTO users (name, email) VALUES
            ('Alice', 'alice@example.com'),
            ('Bob', 'bob@example.com');
          CREATE TABLE IF NOT EXISTS orders (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user VARCHAR(50),
            created_at TIMESTAMP
          );
          INSERT INTO orders (user, created_at) VALUES
            ('Alice', '2025-01-10 12:00:00'),
            ('Alice', '2025-02-15 09:30:00'),
            ('Bob',   '2025-03-22 17:45:00'),
            ('Bob',   '2025-04-05 08:20:00');
          EOF
      volumeMounts:
        - name: initdb
          mountPath: /docker-entrypoint-initdb.d
  containers:
    - name: mariadb
      image: mariadb:10.11
      env:
        - name: MYSQL_ROOT_PASSWORD
          value: examplepassword
      ports:
        - containerPort: 3306
      volumeMounts:
        - name: initdb
          mountPath: /docker-entrypoint-initdb.d
  volumes:
    - name: initdb
      emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: mariadb-test
  namespace: test-mirrord
spec:
  selector:
    app: mariadb-test
  ports:
    - name: mariadb
      port: 3306
      targetPort: 3306
---
apiVersion: v1
kind: Pod
metadata:
  name: mariadb-server-env-val
  namespace: test-mirrord
  labels:
    app: mariadb-server-env-val
spec:
  containers:
    - name: echo
      image: ealen/echo-server:latest
      env:
        - name: MYSQL_CONNECTION_URL
          value: mysql://root:examplepassword@mariadb-test/user
      ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: mariadb-service-env-val
  namespace: test-mirrord
spec:
  selector:
    app: mariadb-server-env-val
  ports:
    - port: 80
      targetPort: 80
  type: ClusterIP
---
apiVersion: v1
kind: Secret
metadata:
  name: mariadb-connection-secret
  namespace: test-mirrord
type: Opaque
stringData:
  url: mysql://root:examplepassword@mariadb-test/user
---
apiVersion: v1
kind: Pod
metadata:
  name: mariadb-server-secret-ref
  namespace: test-mirrord
  labels:
    app: mariadb-server-secret-ref
spec:
  containers:
    - name: echo
      image: ealen/echo-server:latest
      env:
        - name: MYSQL_CONNECTION_URL
          valueFrom:
            secretKeyRef:
              name: mariadb-connection-secret
              key: url
      ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: mariadb-service-secret-ref
  namespace: test-mirrord
spec:
  selector:
    app: mariadb-server-secret-ref
  ports:
    - port: 80
      targetPort: 80
  type: ClusterIP
---
apiVersion: dbs.mirrord.metalbear.co/v1alpha1
kind: MysqlBranchDatabase
metadata:
  name: mariadb-test-branch-env-val
  namespace: test-mirrord
spec:
  id: mariadb-test-env-val-branch
  target:
    pod: mariadb-server-env-val
  connectionSource:
    url:
      env:
        variable: MYSQL_CONNECTION_URL
        container: echo
  databaseName: user
  mysqlVersion: "8.0"
  ttlSecs: 600
  copy:
    mode: all
---
apiVersion: dbs.mirrord.metalbear.co/v1alpha1
kind: MysqlBranchDatabase
metadata:
  name: mariadb-test-branch-secret-ref
  namespace: test-mirrord
spec:
  id: mariadb-test-secret-ref-branch
  target:
    pod: mariadb-server-secret-ref
  connectionSource:
    url:
      env:
        variable: MYSQL_CONNECTION_URL
        container: echo
  databaseName: user
  mysqlVersion: "8.0"
  ttlSecs: 600
  copy:
    mode: schema
    tables:
      users:
        filter: "id > 1"
      orders: {}

